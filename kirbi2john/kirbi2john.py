#!/usr/bin/env python3

# Based on the Kerberoast script from Tim Medin to extract the Kerberos tickets
# from a kirbi file (https://github.com/nidem/kerberoast).
# https://raw.githubusercontent.com/magnumripper/JohnTheRipper/bleeding-jumbo/run/kirbi2john.py
# Modified by Laox to use with hashcat
from pyasn1.codec.ber import decoder
import sys

if __name__ == '__main__':
    m = "exported mimikatz kerberos tickets"

    if len(sys.argv) < 2:
        print("Usage: %s <%s>\n" % (sys.argv[0], m))
        sys.exit(-1)

    for f in sys.argv[1:]:
        with open(f, 'rb') as fd:
            data = fd.read()
            if data[0] == 0x76:  # process .kirbi
                # rem dump
                etype = str(decoder.decode(data)[0][2][0][3][0])
                if etype != "23":
                    print("Unsupported etype %s seen! Please report this to us.\n" % etype)
                etn = decoder.decode(data)[0][2][0][3][2].asNumbers()
                et = ''.join('%.2x' % x for x in etn)
                #print("$krb5tgs$%s$" % etype + et[:16].encode("hex") +
                #                 "$" + et[16:].encode("hex") + "\n")
                print("$krb5tgs${0}${1}${2}\n".format(etype, et[:16*2], et[16*2:]))
            elif data[:2] == b'6b':
                for ticket in data.strip().split('\n'):
                    etype = str(decoder.decode(ticket.decode('hex'))[0][4][3][0])
                    if etype != "23":
                        print("Unsupported etype %s seen! Please report this to us.\n" % etype)
                    etn = decoder.decode(ticket)[0][4][3][2].asNumbers()
                    et = ''.join('%.2x' % x for x in etn)
                    print("$krb5tgs${0}${1}${2}\n".format(etype, et[:16*2], et[16*2:]))
